<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>期待値トラッカー</title>

  <link rel="stylesheet" href="style.css" />

  <!-- iOS / Web App Icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="./assets/icon-180.png?v=9">
  <link rel="icon" type="image/png" sizes="192x192" href="./assets/icon-192.png?v=9">
  <link rel="icon" type="image/png" sizes="512x512" href="./assets/icon-512.png?v=9">

  <!-- iOS Web App -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="期待値トラッカー">
</head>

<body>
  <!-- ロゴ -->
  <h1 class="logo" aria-label="期待値トラッカー">
    <img
      src="./assets/logo-ev-tracker.png"
      alt="期待値トラッカー"
      class="app-logo"
      decoding="async"
      loading="eager"
    />
  </h1>
  <p class="app-version">Version5.0</p>

  <main class="container">

    <!-- 機種選択 + 機種情報 -->
    <section class="card" aria-label="機種情報">
      <div class="machine-row">
        <label class="machine-label">
          機種
          <select id="machineSelect"></select>
        </label>

        <p id="infoBorder" class="equivalent-border machine-fade">ボーダー：— 回/k</p>

        <div class="rate-row">
          <p id="infoJackpot" class="machine-fade">図柄揃い確率：—</p>
          <p id="infoRush" class="machine-fade">ラッシュ突入率：—</p>
        </div>
      </div>
    </section>

    <!-- 回転ログ -->
    <section class="card" id="logCard">

      <!-- 右上ボタンのためのヘッダー -->
      <div class="card-header">
        <h2 class="section-title">回転ログ</h2>
        <button id="btnMidCheck" type="button" class="chip chip-mid-check chip-midcheck-mini">
          回転率チェック
        </button>
      </div>

      <div class="log-input">
        <label>
          データカウンター回転数
          <input type="number" id="counterNow" inputmode="numeric" />
        </label>

        <div class="log-actions" role="group" aria-label="区切りの登録">
          <!-- 通常時に見える -->
          <div class="log-actions-main" id="logActionsMain">
            <button type="button" class="chip state" id="btnStart">開始</button>
            <button type="button" class="chip state" id="btnHit">当たり</button>
            <button type="button" class="chip sub" id="btnUndo">戻す</button>
            <button type="button" class="chip clear" id="btnStop">ヤメ</button>
          </div>

          <!-- 当たり後に見える -->
          <div class="log-actions-after is-hidden" id="logActionsAfter">
            <button type="button" class="chip state" id="btnCharge">チャージ</button>
            <button type="button" class="chip state" id="btnTan">単発</button>
            <button type="button" class="chip state" id="btnRushEnd">RUSH終了</button>
            <button type="button" class="chip state" id="btnLtEnd">LT終了</button>
            <button type="button" class="chip sub" id="btnUndo2">戻す</button>
          </div>

          <!-- 表記出玉 入力パネル（RUSH/LTの時だけ出す） -->
          <div id="payoutPanel" class="is-hidden">
            <label>
              リザルト表記出玉
              <input type="number" id="payoutNow" inputmode="numeric" />
            </label>
            <button type="button" class="chip state" id="btnPayoutConfirm">表記出玉を確定</button>
          </div>

          <!-- 持ち玉 入力パネル（ヤメの時だけ出す） -->
          <div id="endBallsPanel" class="is-hidden">
            <label>
              ヤメ時の持ち玉
              <input type="number" id="endBallsNow" inputmode="numeric" />
            </label>
            <button type="button" class="chip state" id="btnEndBallsConfirm">持ち玉を確定</button>
          </div>
        </div>

        <p class="log-meta">
          初当たり回数 /通常回転数：<span id="hitOverTotal">0 / 0</span>
        </p>
      </div>

      <div class="log-list" id="logList" aria-label="ログ一覧"></div>

      <button type="button" id="resetLogBtn" class="chip clear log-reset-btn">
        当日のログをリセット
      </button>
    </section>

    <!-- 投資（仮確定） -->
    <section class="card" id="investCard">
      <label>
        投資額（今回追加分）
        <input type="number" id="investYen" inputmode="numeric" min="0" step="500"/>
      </label>

      <p id="investConfirmed" class="invest-confirmed">仮確定投資：0 円</p>

      <div class="invest-buttons" role="group" aria-label="投資額の操作">
        <div class="invest-row">
          <button type="button" class="chip" id="add500">+500円</button>
          <button type="button" class="chip" id="add1000">+1000円</button>
          <button type="button" class="chip" id="add5000">+5000円</button>
        </div>

        <div class="invest-row">
          <button type="button" class="chip sub" id="sub500">−500円</button>
          <button type="button" class="chip neutral" id="skipInvest">追加無し</button>
          <button type="button" class="chip clear" id="clearInvest">クリア</button>
        </div>
      </div>

      <button type="button" id="calcBtn">投資額の追加</button>

      <p id="result" aria-live="polite"></p>
    </section>

    <!-- 期待値計算（別カード） -->
    <section class="card" id="finalCalcCard">
      <button type="button" id="finalCalcBtn">期待値計算</button>

      <p id="finalResult" class="final-result" aria-live="polite"></p>

      <div class="rate-meter rate-meter--compact is-hidden" id="finalRateMeter" aria-label="今回の回転率メーター">
        <div class="rate-meter__scale">
          <span id="finalMeterMin" class="rate-meter__tick">—</span>
          <span class="rate-meter__tick">ボーダー</span>
          <span id="finalMeterMax" class="rate-meter__tick">—</span>
        </div>

        <div class="rate-meter__bar">
          <div class="rate-meter__border"></div>
          <div class="rate-meter__needle" id="finalMeterNeedle" style="left:50%"></div>
        </div>

        <div class="rate-meter__labels">
          <span>低い</span>
          <span>高い</span>
        </div>
      </div>
    </section>

    <!-- 累計 -->
    <section class="card" id="totalCard">
      <p id="totalSpin">累計確率：0</p>
      <p id="totalInvest">累計投資：0 円</p>
      <p id="avgRate">累計回転率：0 回/k</p>
      <p id="total">累積期待値：0 玉</p>

      <div class="goal">
        <p class="goal-title"></p>
        <progress id="goalBar" value="0" max="1000000"></progress>
        <p id="percent">達成率：0.00 %</p>
      </div>

      <p class="note">※ボーダー表示は28交換、期待値計算は等価換算です</p>
      <button type="button" id="resetBtn">リセット</button>
    </section>

  </main>

  <!-- scripts（先に machines → app の順） -->
  <script src="./machines.js"></script>
  <script src="./app.js"></script>

  <!-- 途中経過：背景オーバーレイ（外タップで閉じる） -->
  <div id="midOverlay" class="mid-overlay is-hidden" aria-hidden="true"></div>

  <!-- 途中経過：モーダル -->
  <div id="midCheckCard" class="card mid-modal is-hidden" aria-label="途中経過">
    <h3 class="section-title">途中経過</h3>

    <div class="rate-meter" id="midRateMeter" aria-label="回転率メーター">
      <div class="rate-meter__scale">
        <span id="midMeterMin" class="rate-meter__tick">—</span>
        <span id="midMeterCenter" class="rate-meter__tick">ボーダー</span>
        <span id="midMeterMax" class="rate-meter__tick">—</span>
      </div>

      <div class="rate-meter__bar">
        <div class="rate-meter__border"></div>
        <div class="rate-meter__needle" id="midMeterNeedle" style="left:50%"></div>
      </div>

      <div class="rate-meter__labels">
        <span>低い</span>
        <span>高い</span>
      </div>
    </div>

    <div class="kv-list">
      <div class="kv-row">
        <span class="kv-key">回転数</span>
        <span class="kv-val" id="midSpinVal">—</span>
      </div>

      <div class="kv-row">
        <span class="kv-key">現在の回転率</span>
        <span class="kv-val" id="midRateVal">—</span>
      </div>

      <div class="kv-row">
        <span class="kv-key">28交換ボーダー</span>
        <span class="kv-val" id="midBorderVal">—</span>
      </div>

      <div class="kv-row">
        <span class="kv-key">差</span>
        <span class="kv-val" id="midDiffVal">—</span>
      </div>
    </div>

    <!-- ✅閉じるボタン復活 -->
    <button id="midCheckClose" type="button" class="chip clear">閉じる</button>
  </div>

</body>
</html>
